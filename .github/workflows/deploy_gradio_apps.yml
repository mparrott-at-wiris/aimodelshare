# ----------------------------------------------------------------
  # JOB 2: DEPLOY (Deploy Many)
  # ----------------------------------------------------------------
  deploy-services:
    needs: build-and-push
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        app_name:
          - tutorial
          - judge
          - ai-consequences
          - what-is-ai
          - model-building-game
          - ethical-revelation
          - moral-compass-challenge
          - bias-detective
          - fairness-fixer
          - justice-equity-upgrade

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Show Docker Image Tag
        run: |
          echo "Deploying image: ${{ needs.build-and-push.outputs.image_tag }} to service: ${{ matrix.app_name }}"

      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ matrix.app_name }}
          image: ${{ needs.build-and-push.outputs.image_tag }}
          region: ${{ env.REGION }}
          # We use >- to allow this long string to be split on multiple lines for safety
          flags: >-
            --allow-unauthenticated
            --memory=1Gi
            --cpu=1
            --session-affinity
            --concurrency=80
            --min-instances=0
            --max-instances=50
          env_vars: |-
            APP_NAME=${{ matrix.app_name }}
            GRADIO_SERVER_NAME=0.0.0.0
            GRADIO_ANALYTICS_ENABLED=False
            GRADIO_NUM_PORTS=1

      - name: Show Service URL
        run: echo "Service URL: ${{ steps.deploy.outputs.url }}"
