name: Deploy Moral Compass Apps to Production

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]
    paths:
      - 'aimodelshare/moral_compass/apps/**'
      - 'requirements-apps.txt'
      - 'launch_entrypoint.py'
      - 'Dockerfile'
      - '.github/workflows/deploy_gradio_apps.yml'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  REPO_NAME: moral-compass-apps

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    outputs:
      image_tag: ${{ steps.image-tag.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - id: auth
        name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          # For keyless (future):
          # workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          # service_account: ${{ secrets.DEPLOYER_SA }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker Auth
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      # OPTIONAL: Cache Python deps if the Dockerfile copies requirements first.
      # - name: Cache pip
      #   uses: actions/cache@v4
      #   with:
      #     path: ~/.cache/pip
      #     key: pip-${{ runner.os }}-${{ hashFiles('requirements*.txt') }}
      #     restore-keys: |
      #       pip-${{ runner.os }}-

      - name: Build and Push Docker Image
        id: image-tag
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/gradio-universal:${{ github.sha }}"
          docker build --pull -t "$IMAGE" .
          docker push "$IMAGE"
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"

      # OPTIONAL: Add a 'latest' mutable tag if desired for quick rollbacks
      # - name: Tag latest
      #   run: |
      #     LATEST_IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/gradio-universal:latest"
      #     docker tag "${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/gradio-universal:${{ github.sha }}" "$LATEST_IMAGE"
      #     docker push "$LATEST_IMAGE"

  deploy-services:
    needs: build-and-push
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        app_name: [
          "tutorial",
          "judge",
          "ai-consequences",
          "what-is-ai",
          "model-building-game",
          "ethical-revelation",
          "moral-compass-challenge",
          "bias-detective",
          "fairness-fixer",
          "justice-equity-upgrade"
        ]
        # OPTIONAL: per-service overrides example:
        # include:
        #   - app_name: tutorial
        #     min_instances: 1
        #   - app_name: judge
        #     min_instances: 1
    steps:
      - id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # OPTIONAL: Set up Cloud SDK if you plan custom gcloud commands
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Show Docker Image Tag
        run: echo "Deploying image: ${{ needs.build-and-push.outputs.image_tag }} to service: ${{ matrix.app_name }}"

      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v1
        with:
          service: ${{ matrix.app_name }}
          image: ${{ needs.build-and-push.outputs.image_tag }}
          region: ${{ env.REGION }}
          # You can lower concurrency if latency is high (e.g. --concurrency=40)
          # Add --timeout=600 if needed, --cpu-boost for faster cold starts.
          flags: >-
            --allow-unauthenticated
            --memory=1Gi
            --cpu=1
            --session-affinity
            --concurrency=80
            --min-instances=0
            --max-instances=50
            # --timeout=600
            # --cpu-boost
            # --revision-suffix=${{ github.run_number }}-${{ matrix.app_name }}
            # --ingress=all
          env_vars: |
            APP_NAME=${{ matrix.app_name }}
            GRADIO_SERVER_NAME=0.0.0.0
            GRADIO_ANALYTICS_ENABLED=False
            GRADIO_NUM_PORTS=1

      # OPTIONAL: Output service URL
      - name: Show Service URL
        if: steps.deploy.outputs.url != ''
        run: echo "Service URL: ${{ steps.deploy.outputs.url }}"

