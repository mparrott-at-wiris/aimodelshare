name: Deploy Moral Compass Apps to Production

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]
    paths:
      - 'aimodelshare/moral_compass/apps/**'
      - 'requirements-apps.txt'
      - 'launch_entrypoint.py'
      - 'Dockerfile'
      - '.github/workflows/deploy_gradio_apps.yml'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  REPO_NAME: moral-compass-apps

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      image: ${{ steps.export-image.outputs.image }}
    steps:
      - name: Verify required secrets
        run: |
          if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "Missing secret GCP_SA_KEY. Aborting."
            exit 1
          fi
          if [ -z "${{ secrets.GCP_PROJECT_ID }}" ]; then
            echo "Missing secret GCP_PROJECT_ID. Aborting."
            exit 1
          fi

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker Auth
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build and Push Docker Image
        run: |
          set -e
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/gradio-universal:${{ github.sha }}"
          echo "Building image: $IMAGE"
          docker build --pull -t "$IMAGE" .
          docker push "$IMAGE"
          echo "Built and pushed image: $IMAGE"

      - name: Export Image Output
        id: export-image
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/gradio-universal:${{ github.sha }}"
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"
          echo "Exported image output: $IMAGE"

  # Template for deploy jobs
  deploy-tutorial:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Authenticate
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      - name: Debug image output
        run: |
          echo "Resolved image output: ${{ needs.build-and-push.outputs.image }}"
          if [ -z "${{ needs.build-and-push.outputs.image }}" ]; then
            echo "ERROR: Image output is empty. Aborting deploy."
            exit 1
          fi
      - name: Deploy tutorial
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: tutorial
          image: ${{ needs.build-and-push.outputs.image }}
          region: ${{ env.REGION }}
          flags: >-
            --allow-unauthenticated
            --memory=2Gi
            --cpu=2
            --session-affinity
            --concurrency=80
            --min-instances=0
            --max-instances=50
            --timeout=3000
            --set-env-vars=APP_NAME=tutorial,GRADIO_SERVER_NAME=0.0.0.0,GRADIO_ANALYTICS_ENABLED=False,GRADIO_NUM_PORTS=1

  deploy-judge:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Debug image output
        run: |
          echo "Resolved image output: ${{ needs.build-and-push.outputs.image }}"
          if [ -z "${{ needs.build-and-push.outputs.image }}" ]; then
            echo "ERROR: Image output is empty. Aborting deploy."
            exit 1
          fi
      - name: Deploy judge
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: judge
          image: ${{ needs.build-and-push.outputs.image }}
          region: ${{ env.REGION }}
          flags: >-
            --allow-unauthenticated
            --memory=2Gi
            --cpu=2
            --session-affinity
            --concurrency=80
            --min-instances=0
            --max-instances=50
            --timeout=3000
            --set-env-vars=APP_NAME=judge,GRADIO_SERVER_NAME=0.0.0.0,GRADIO_ANALYTICS_ENABLED=False,GRADIO_NUM_PORTS=1

  deploy-ai-consequences:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Debug image output
        run: |
          echo "Resolved image output: ${{ needs.build-and-push.outputs.image }}"
          if [ -z "${{ needs.build-and-push.outputs.image }}" ]; then
            echo "ERROR: Image output is empty. Aborting deploy."
            exit 1
          fi
      - name: Deploy ai-consequences
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ai-consequences
          image: ${{ needs.build-and-push.outputs.image }}
          region: ${{ env.REGION }}
          flags: >-
            --allow-unauthenticated
            --memory=2Gi
            --cpu=2
            --session-affinity
            --concurrency=80
            --min-instances=0
            --max-instances=50
            --timeout=3000
            --set-env-vars=APP_NAME=ai-consequences,GRADIO_SERVER_NAME=0.0.0.0,GRADIO_ANALYTICS_ENABLED=False,GRADIO_NUM_PORTS=1

  deploy-what-is-ai:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Debug image output
        run: |
          echo "Resolved image output: ${{ needs.build-and-push.outputs.image }}"
          if [ -z "${{ needs.build-and-push.outputs.image }}" ]; then
            echo "ERROR: Image output is empty. Aborting deploy."
            exit 1
          fi
      - name: Deploy what-is-ai
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: what-is-ai
          image: ${{ needs.build-and-push.outputs.image }}
          region: ${{ env.REGION }}
          flags: >-
            --allow-unauthenticated
            --memory=2Gi
            --cpu=2
            --session-affinity
            --concurrency=80
            --min-instances=0
            --max-instances=50
            --timeout=3000
            --set-env-vars=APP_NAME=what-is-ai,GRADIO_SERVER_NAME=0.0.0.0,GRADIO_ANALYTICS_ENABLED=False,GRADIO_NUM_PORTS=1

  deploy-model-building-game:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Debug image output
        run: |
          echo "Resolved image output: ${{ needs.build-and-push.outputs.image }}"
          if [ -z "${{ needs.build-and-push.outputs.image }}" ]; then
            echo "ERROR: Image output is empty. Aborting deploy."
            exit 1
          fi
      - name: Deploy model-building-game
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: model-building-game
          image: ${{ needs.build-and-push.outputs.image }}
          region: ${{ env.REGION }}
          flags: >-
            --allow-unauthenticated
            --memory=2Gi
            --cpu=2
            --session-affinity
            --concurrency=80
            --min-instances=0
            --max-instances=50
            --timeout=3000
            --set-env-vars=APP_NAME=model-building-game,GRADIO_SERVER_NAME=0.0.0.0,GRADIO_ANALYTICS_ENABLED=False,GRADIO_NUM_PORTS=1

  deploy-ethical-revelation:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Debug image output
        run: |
          echo "Resolved image output: ${{ needs.build-and-push.outputs.image }}"
          if [ -z "${{ needs.build-and-push.outputs.image }}" ]; then
            echo "ERROR: Image output is empty. Aborting deploy."
            exit 1
          fi
      - name: Deploy ethical-revelation
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ethical-revelation
          image: ${{ needs.build-and-push.outputs.image }}
          region: ${{ env.REGION }}
          flags: >-
            --allow-unauthenticated
            --memory=2Gi
            --cpu=2
            --session-affinity
            --concurrency=80
            --min-instances=0
            --max-instances=50
            --timeout=3000
            --set-env-vars=APP_NAME=ethical-revelation,GRADIO_SERVER_NAME=0.0.0.0,GRADIO_ANALYTICS_ENABLED=False,GRADIO_NUM_PORTS=1

  deploy-moral-compass-challenge:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Debug image output
        run: |
          echo "Resolved image output: ${{ needs.build-and-push.outputs.image }}"
          if [ -z "${{ needs.build-and-push.outputs.image }}" ]; then
            echo "ERROR: Image output is empty. Aborting deploy."
            exit 1
          fi
      - name: Deploy moral-compass-challenge
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: moral-compass-challenge
          image: ${{ needs.build-and-push.outputs.image }}
          region: ${{ env.REGION }}
          flags: >-
            --allow-unauthenticated
            --memory=2Gi
            --cpu=2
            --session-affinity
            --concurrency=80
            --min-instances=0
            --max-instances=50
            --timeout=3000
            --set-env-vars=APP_NAME=moral-compass-challenge,GRADIO_SERVER_NAME=0.0.0.0,GRADIO_ANALYTICS_ENABLED=False,GRADIO_NUM_PORTS=1

  deploy-bias-detective:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Debug image output
        run: |
          echo "Resolved image output: ${{ needs.build-and-push.outputs.image }}"
          if [ -z "${{ needs.build-and-push.outputs.image }}" ]; then
            echo "ERROR: Image output is empty. Aborting deploy."
            exit 1
          fi
      - name: Deploy bias-detective
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: bias-detective
          image: ${{ needs.build-and-push.outputs.image }}
          region: ${{ env.REGION }}
          flags: >-
            --allow-unauthenticated
            --memory=2Gi
            --cpu=2
            --session-affinity
            --concurrency=80
            --min-instances=0
            --max-instances=50
            --timeout=3000
            --set-env-vars=APP_NAME=bias-detective,GRADIO_SERVER_NAME=0.0.0.0,GRADIO_ANALYTICS_ENABLED=False,GRADIO_NUM_PORTS=1

  deploy-fairness-fixer:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Debug image output
        run: |
          echo "Resolved image output: ${{ needs.build-and-push.outputs.image }}"
          if [ -z "${{ needs.build-and-push.outputs.image }}" ]; then
            echo "ERROR: Image output is empty. Aborting deploy."
            exit 1
          fi
      - name: Deploy fairness-fixer
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: fairness-fixer
          image: ${{ needs.build-and-push.outputs.image }}
          region: ${{ env.REGION }}
          flags: >-
            --allow-unauthenticated
            --memory=2Gi
            --cpu=2
            --session-affinity
            --concurrency=80
            --min-instances=0
            --max-instances=50
            --timeout=3000
            --set-env-vars=APP_NAME=fairness-fixer,GRADIO_SERVER_NAME=0.0.0.0,GRADIO_ANALYTICS_ENABLED=False,GRADIO_NUM_PORTS=1

  deploy-justice-equity-upgrade:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - uses: google-github-actions/setup-gcloud@v2
      - name: Debug image output
        run: |
          echo "Resolved image output: ${{ needs.build-and-push.outputs.image }}"
          if [ -z "${{ needs.build-and-push.outputs.image }}" ]; then
            echo "ERROR: Image output is empty. Aborting deploy."
            exit 1
          fi
      - name: Deploy justice-equity-upgrade
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: justice-equity-upgrade
          image: ${{ needs.build-and-push.outputs.image }}
          region: ${{ env.REGION }}
          flags: >-
            --allow-unauthenticated
            --memory=2Gi
            --cpu=2
            --session-affinity
            --concurrency=80
            --min-instances=0
            --max-instances=50
            --timeout=3000
            --set-env-vars=APP_NAME=justice-equity-upgrade,GRADIO_SERVER_NAME=0.0.0.0,GRADIO_ANALYTICS_ENABLED=False,GRADIO_NUM_PORTS=1
