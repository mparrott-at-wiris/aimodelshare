name: Gradio v5.49.1 Smoke Test

on:
  workflow_dispatch:
    inputs:
      install_source:
        description: "Install aimodelshare from 'pypi' or 'repo'"
        required: false
        default: "pypi"
        type: choice
        options:
          - pypi
          - repo
      pypi_version:
        description: "Specific PyPI version of aimodelshare to install (optional)"
        required: false
        type: string

jobs:
  gradio-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      matrix:
        python-version: ["3.12"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install dependencies (aimodelshare + test libs + Gradio)
        run: |
          pip install boto3 onnx onnxmltools onnxruntime Pympler scikeras shortuuid skl2onnx tf2onnx wget
          if [ "${{ github.event.inputs.install_source }}" = "pypi" ]; then
            if [ -n "${{ github.event.inputs.pypi_version }}" ]; then
              pip install "aimodelshare==${{ github.event.inputs.pypi_version }}"
            else
              pip install aimodelshare
            fi
          else
            pip install -e .
          fi
          pip install pytest scikit-learn pandas numpy opencv-python-headless tensorflow pydot regex psutil ipython "PyJWT<2.0" matplotlib seaborn importlib_resources onnxscript requests
          pip install --index-url https://download.pytorch.org/whl/cpu torch torchvision
          pip install "gradio==5.49.1"

      - name: Environment info
        run: |
          python -c "import gradio, sys; print('Gradio:', gradio.__version__); print(sys.version)"
          python -c "import aimodelshare; print('aimodelshare imported from:', aimodelshare.__file__)"

      - name: Run smoke tests
        env:
          GRADIO_ANALYTICS_ENABLED: "false"
          GRADIO_DEBUG: "false"
          DEBUG: "false"
        run: |
          pytest -q --maxfail=1 --timeout=120 -k gradio_smoke

      - name: Show logs on failure
        if: failure()
        run: |
          echo "Listing workspace for debugging:"
          ls -R .
