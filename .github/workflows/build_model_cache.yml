name: Build Prediction Cache Artifact (Resumable)

on:
  workflow_dispatch:

jobs:
  build-cache-chunk:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Explicitly set to match the script's safety limit
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install Dependencies
        run: pip install pandas numpy scikit-learn joblib

      # 1. Download previous checkpoint (if it exists)
      # We use 'action-download-artifact' to get artifacts from the LAST run of this same workflow
      - name: Restore Checkpoint
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: build-cache.yml
          name: cache-checkpoint
          path: .
          search_artifacts: true
          if_no_artifact_found: warn
        continue-on-error: true

      # 2. Run the script (It handles resuming automatically)
      - name: Run Compute Chunk
        run: |
          export OMP_NUM_THREADS=1
          export OPENBLAS_NUM_THREADS=1
          python precompute_cache.py

      # 3. Save Checkpoint (For the NEXT run)
      - name: Save Checkpoint
        if: always() # Save even if timeout happens
        uses: actions/upload-artifact@v4
        with:
          name: cache-checkpoint
          path: cache_checkpoint.jsonl
          retention-days: 5

      # 4. Save Final Result (Only if the script actually finished and created it)
      - name: Save Final Artifact
        if: hashFiles('prediction_cache.json.gz') != ''
        uses: actions/upload-artifact@v4
        with:
          name: prediction-cache-file
          path: prediction_cache.json.gz
          retention-days: 90
